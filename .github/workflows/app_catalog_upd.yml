name: Update Flipper Application Catalog

on:
  push:
    branches:
      - main
    paths:
      - 'application.fam'

jobs:
  update-catalog:
    runs-on: ubuntu-latest

    env:
      BRANCH_PREFIX: zacharyweiss/
      APP_NAME: magspoof
      APP_FOLDER: GPIO
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Get fap_version
      id: fap_version
      run: |
        fap_version_raw=$(grep -oP '(?<=fap_version=\()\d+, \d+(?=\))' application.fam)
        v_major=$(echo $fap_version_raw | cut -d "," -f 1 | xargs)
        v_minor=$(echo $fap_version_raw | cut -d "," -f 2 | xargs)
        echo "v_major=$v_major" >> "$GITHUB_ENV"
        echo "v_minor=$v_minor" >> "$GITHUB_ENV"
        echo "branch_name=${{ env.BRANCH_PREFIX }}${{ env.APP_NAME }}_v$v_major.$v_minor" >> "$GITHUB_ENV"
        
    - name: Fork Flipper Application Catalog
      uses: actions/checkout@v3
      with:
        repository: 'zacharyweiss/actions-test-remote'
        path: 'actions-test-remote'
        
    - name: Create Branch
      run: |
        cd flipper-application-catalog
        git checkout -b "${{ env.branch_name }}"


    - name: Update manifest.yml
      run: |
        manifest_path=applications/${{ env.APP_FOLDER }}/${{ env.APP_NAME }}/manifest.yml
        echo "manifest_path=$manifest_path" > "$GITHUB_ENV"
        echo "commit_sha: ${{ github.sha }}" >> actions-test-remote/$manifest_path

    
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update report
        committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: ${{ env.branch_name }}
        delete-branch: true
        title: '[Example] Update'
        body: |
          Update report
          - Auto-generated by [create-pull-request][1]
        draft: false
